# Penetration Testing Suite

Comprehensive security testing tools for the Trailhead backend.

## Setup

1. **Install dependencies:**
   ```bash
   cd backend
   pip install -r requirements-pentest.txt
   ```

2. **Ensure backend is running:**
   ```bash
   # In one terminal
   cd backend
   uvicorn app.main:app --reload
   ```

## Tools

### 1. Automated Security Scanner (`security_scanner.py`)

Comprehensive OWASP Top 10 vulnerability scanner.

**Usage:**
```bash
# Basic scan
python pentest/security_scanner.py --url http://localhost:8000

# Verbose output
python pentest/security_scanner.py --url http://localhost:8000 --verbose

# Save results to JSON
python pentest/security_scanner.py --url http://localhost:8000 --output security-report.json
```

**Tests:**
- âœ… Security Headers (CSP, HSTS, X-Frame-Options, etc.)
- âœ… CORS Configuration
- âœ… SQL Injection vulnerabilities
- âœ… XSS (Cross-Site Scripting) vulnerabilities
- âœ… Authentication bypass attempts
- âœ… Rate limiting effectiveness
- âœ… Information disclosure in errors
- âœ… HTTPS enforcement
- âœ… Authorization flaws
- âœ… Verbose error messages

**Output:**
```
================================================================
TRAILHEAD SECURITY SCANNER
================================================================

[TEST] Security Headers
âœ… PASS: Content-Security-Policy header present
âœ… PASS: X-Frame-Options header present
...

================================================================
SUMMARY
================================================================
Total Tests: 45
Passed: 42
Failed: 3
Critical: 1
High: 2
Medium: 0
```

### 2. Load Testing (`load_test.py`)

Simulates realistic user traffic to test performance and identify bottlenecks.

**Usage:**
```bash
# Launch Locust web UI
locust -f pentest/load_test.py --host=http://localhost:8000

# Open http://localhost:8089 in browser
# Configure:
# - Number of users: 10-100
# - Spawn rate: 1-10 users/second
# - Duration: 1m-10m

# Headless mode (CI/CD)
locust -f pentest/load_test.py --host=http://localhost:8000 \
  --users 50 --spawn-rate 5 --run-time 2m --headless
```

**Test Scenarios:**
- **Unauthenticated Users:** Public endpoints (health, docs)
- **Authenticated Users:** Protected endpoints with valid JWT tokens

**Metrics:**
- Response times (p50, p95, p99)
- Requests per second
- Failure rates
- Concurrent user capacity

### 3. JWT Security Testing (`jwt_security_test.py`)

Tests JWT token handling and validation.

**Usage:**
```bash
# Run all JWT tests
python pentest/jwt_security_test.py http://localhost:8000
```

**Tests:**
- âœ… Missing token rejection
- âœ… Malformed token rejection
- âœ… Expired token rejection
- âœ… Token location validation (must be in Authorization header)
- âœ… Algorithm confusion attack (none algorithm)

## Static Analysis Tools

### Bandit (Security Linter)

Scans Python code for security vulnerabilities.

```bash
# Scan entire backend
bandit -r app/ -f json -o bandit-report.json

# Scan with severity filter (high + medium)
bandit -r app/ -ll

# Exclude test files
bandit -r app/ -x */tests/*
```

**Checks for:**
- Hardcoded passwords
- SQL injection risks
- Use of `exec()` or `eval()`
- Weak cryptographic algorithms
- Insecure deserialization

### Safety (Dependency Checker)

Checks for known security vulnerabilities in dependencies.

```bash
# Check current environment
safety check

# Check requirements file
safety check -r requirements.txt

# Generate JSON report
safety check --json --output safety-report.json
```

## Continuous Integration

### GitHub Actions Workflow

Add to `.github/workflows/security.yml`:

```yaml
name: Security Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-pentest.txt
      
      - name: Run Bandit
        run: bandit -r backend/app/ -f json -o bandit-report.json
        continue-on-error: true
      
      - name: Check dependencies
        run: safety check -r backend/requirements.txt --json --output safety-report.json
        continue-on-error: true
      
      - name: Start backend
        run: |
          cd backend
          uvicorn app.main:app &
          sleep 5
      
      - name: Run security scanner
        run: python backend/pentest/security_scanner.py --url http://localhost:8000 --output security-report.json
      
      - name: Upload reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            security-report.json
```

## Testing Strategy

### 1. Daily (Automated)
- Run `security_scanner.py` against staging environment
- Check for new dependency vulnerabilities with `safety check`

### 2. Weekly (Automated)
- Full Bandit scan of codebase
- Load testing with 50-100 concurrent users
- JWT security tests

### 3. Before Deployment (Manual)
- Run all automated tests
- Review security reports
- Verify rate limiting under load
- Test with production-like data

### 4. Quarterly (Manual)
- External penetration test
- Security audit of new features
- Review and update security policies

## Interpreting Results

### Security Scanner

**Critical Issues:**
- ðŸ”´ Must fix immediately
- Block deployment
- Examples: SQL injection, authentication bypass

**High Severity:**
- ðŸŸ  Fix within 1 week
- Examples: Missing security headers, XSS vulnerabilities

**Medium Severity:**
- ðŸŸ¡ Fix within 1 month
- Examples: Information disclosure, verbose errors

**Low Severity:**
- ðŸŸ¢ Fix when convenient
- Examples: Minor configuration improvements

### Load Testing

**Good Performance:**
- p95 response time < 500ms
- Failure rate < 1%
- Can handle 50+ concurrent users

**Needs Optimization:**
- p95 response time > 1s
- Failure rate > 5%
- Rate limiting kicking in under normal load

## Troubleshooting

### Security Scanner Fails to Connect

```bash
# Check backend is running
curl http://localhost:8000/health

# Check firewall/port
netstat -an | grep 8000
```

### Load Test Authentication Fails

```bash
# Update JWT tokens in load_test.py
# Get valid token from Clerk dashboard or /clerk/me endpoint
```

### False Positives

Some tests may fail due to configuration:
- HTTPS enforcement: May fail in local dev (expected)
- CORS: May flag legitimate origins
- Rate limiting: May need adjustment for test scenarios

Review results and update test thresholds as needed.

## Best Practices

1. **Never commit real credentials** to pentest scripts
2. **Run tests in isolated environment** (not production)
3. **Review reports regularly** - don't let issues accumulate
4. **Automate what you can** - integrate into CI/CD
5. **Keep tools updated** - `pip install -U -r requirements-pentest.txt`
6. **Document exceptions** - if you must accept a risk, document why

## Resources

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Locust Documentation](https://docs.locust.io/)
- [Bandit Documentation](https://bandit.readthedocs.io/)
- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)

## Support

For issues or questions:
1. Check existing security reports in this directory
2. Review `SECURITY_AUDIT_REPORT.md` in project root
3. Consult `ADDITIONAL_SECURITY_RECOMMENDATIONS.md` in backend/
