#!/usr/bin/env python3
"""
Load Testing Script for Trailhead Backend
Tests API performance and rate limiting under load
"""

from locust import HttpUser, task, between, events
import json
import random


class TrailheadUser(HttpUser):
    """Simulated user for load testing"""
    
    wait_time = between(1, 3)  # Wait 1-3 seconds between tasks
    
    def on_start(self):
        """Called when a simulated user starts"""
        # Optionally authenticate
        pass
    
    @task(5)
    def get_available_outings(self):
        """Get available outings (most common operation)"""
        self.client.get("/api/outings/available")
    
    @task(3)
    def get_all_outings(self):
        """Get all outings"""
        self.client.get("/api/outings")
    
    @task(2)
    def get_specific_outing(self):
        """Get a specific outing"""
        # You'll need to update this with a real outing ID
        outing_id = "00000000-0000-0000-0000-000000000000"
        self.client.get(f"/api/outings/{outing_id}")
    
    @task(1)
    def health_check(self):
        """Health check endpoint"""
        self.client.get("/api/health")


class AuthenticatedUser(HttpUser):
    """Simulated authenticated user"""
    
    wait_time = between(2, 5)
    
    def on_start(self):
        """Login on start"""
        # Add your authentication logic here
        self.token = None  # Replace with actual token
        if self.token:
            self.client.headers = {
                'Authorization': f'Bearer {self.token}'
            }
    
    @task(3)
    def get_my_family(self):
        """Get family members"""
        if self.token:
            self.client.get("/api/family")
    
    @task(2)
    def get_my_signups(self):
        """Get my signups"""
        if self.token:
            self.client.get("/api/signups/my-signups")
    
    @task(1)
    def get_user_info(self):
        """Get current user info"""
        if self.token:
            self.client.get("/api/clerk/me")


# Event handlers for custom metrics
@events.request.add_listener
def on_request(request_type, name, response_time, response_length, exception, **kwargs):
    """Track custom metrics"""
    if exception:
        print(f"Request failed: {name} - {exception}")


# Run with: locust -f pentest/load_test.py --host=http://localhost:8000
