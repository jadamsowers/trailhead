#!/bin/bash
# Quick start script for penetration testing

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "======================================"
echo "Trailhead Security Testing Suite"
echo "======================================"
echo

# Check if backend directory exists
if [ ! -d "backend" ]; then
    echo -e "${RED}Error: Run this script from the project root${NC}"
    exit 1
fi

cd backend

# Check if dependencies are installed
echo -e "${YELLOW}Checking dependencies...${NC}"
if ! pip show pytest &> /dev/null; then
    echo -e "${YELLOW}Installing pentest dependencies...${NC}"
    pip install -r requirements-pentest.txt
else
    echo -e "${GREEN}✓ Dependencies already installed${NC}"
fi

# Check if backend is running
echo -e "${YELLOW}Checking if backend is running...${NC}"
if ! curl -s http://localhost:8000/health > /dev/null 2>&1; then
    echo -e "${RED}Error: Backend is not running${NC}"
    echo "Start the backend first:"
    echo "  cd backend && uvicorn app.main:app --reload"
    exit 1
fi
echo -e "${GREEN}✓ Backend is running${NC}"
echo

# Run static analysis
echo "======================================"
echo "1. Static Analysis (Bandit)"
echo "======================================"
bandit -r app/ -ll -f screen || true
echo

# Run dependency check
echo "======================================"
echo "2. Dependency Vulnerability Check"
echo "======================================"
safety check || true
echo

# Run JWT security tests
echo "======================================"
echo "3. JWT Security Tests"
echo "======================================"
python pentest/jwt_security_test.py http://localhost:8000
echo

# Run automated security scanner
echo "======================================"
echo "4. Automated Security Scanner"
echo "======================================"
python pentest/security_scanner.py --url http://localhost:8000 --verbose --output pentest-report.json
echo

echo "======================================"
echo "Testing Complete!"
echo "======================================"
echo -e "${GREEN}Results saved to: backend/pentest-report.json${NC}"
echo
echo "Next steps:"
echo "  1. Review pentest-report.json for any security issues"
echo "  2. Run load tests: locust -f pentest/load_test.py --host=http://localhost:8000"
echo "  3. Address any critical or high-severity findings"
echo
